<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prescrição Digital - MedClinic</title>
    <link href="../css/tailwind-built.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/prescription.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-background-dark text-white font-display">
    <!-- Header -->
    <header class="focus-header">
        <div class="focus-header-inner">
            <div class="presc-header-left">
                <a href="doctor-dashboard.html" class="presc-back-link">
                    <span class="material-symbols-outlined">arrow_back</span>
                </a>
                <div class="presc-brand">
                    <span class="material-symbols-outlined">local_hospital</span>
                    <span class="presc-brand-name">MedClinic</span>
                </div>
            </div>
            <h1 class="presc-view-title">Nova Prescrição</h1>
            <div class="u-fs-lg u-w-40"></div>
        </div>
    </header>

    <main class="prescription-container">
        <!-- Patient Selection -->
        <section class="prescription-section">
            <h2 class="section-title">
                <span class="material-symbols-outlined u-text-primary">person</span>
                Paciente
            </h2>
            <div class="u-flex u-items-center u-gap-medium">
                <select id="patient-select" class="pep-select">
                    <option value="">Selecione o paciente...</option>
                </select>
                <div id="patient-info" class="patient-info-display u-hidden">
                    <p id="patient-name" class="patient-name-text"></p>
                    <p id="patient-details" class="patient-details-text"></p>
                </div>
            </div>
        </section>

        <!-- Medications -->
        <section class="prescription-section">
            <div class="medications-header-flex">
                <h2 class="section-title u-margin-0">
                    <span class="material-symbols-outlined u-text-primary">medication</span>
                    Medicamentos
                </h2>
                <button onclick="addMedication()" class="btn-add-med">
                    <span class="material-symbols-outlined u-fs-lg">add_circle</span>
                    Adicionar
                </button>
            </div>

            <div id="medications-list">
                <!-- Medications will be added here -->
            </div>
        </section>

        <!-- Notes -->
        <section class="prescription-section">
            <h2 class="section-title">
                <span class="material-symbols-outlined u-text-primary">notes</span>
                Observações
            </h2>
            <textarea id="prescription-notes" rows="4" placeholder="Orientações adicionais para o paciente..."
                class="pep-textarea"></textarea>
        </section>

        <!-- Actions -->
        <div class="u-flex u-gap-medium">
            <button onclick="savePrescription(false)" class="btn-save-draft">
                Salvar Rascunho
            </button>
            <button onclick="savePrescription(true)" class="btn-issue-digital">
                <span class="material-symbols-outlined">verified</span>
                Emitir Prescrição Digital
            </button>
        </div>

        <!-- Preview Modal -->
        <div id="preview-modal" class="preview-modal-overlay u-hidden">
            <div class="preview-modal-content">
                <div class="preview-modal-header">
                    <h3 class="u-fs-lg u-fw-700 u-margin-0">Pré-visualização</h3>
                    <button onclick="closePreview()" class="btn-icon-action">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div id="preview-content" class="preview-modal-body">
                    <!-- Preview content will be injected here -->
                </div>
                <div class="preview-modal-footer">
                    <button onclick="closePreview()" class="btn-save-draft u-padding-medium">
                        Editar
                    </button>
                    <button onclick="confirmAndDownload()" class="btn-issue-digital u-padding-medium">
                        <span class="material-symbols-outlined">download</span>
                        Baixar PDF
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Medication Template -->
    <template id="medication-template">
        <div class="medication-item">
            <div class="medication-header">
                <span class="u-fw-600 u-text-primary">Medicamento</span>
                <button type="button" onclick="removeMedication(this)" class="btn-icon-action u-text-red">
                    <span class="material-symbols-outlined u-fs-lg">delete</span>
                </button>
            </div>
            <div class="medication-grid">
                <input type="text" placeholder="Nome do medicamento" class="pep-input med-name">
                <input type="text" placeholder="Dosagem (ex: 50mg)" class="pep-input med-dosage">
                <input type="text" placeholder="Frequência (ex: 12/12h)" class="pep-input med-frequency">
                <input type="text" placeholder="Duração (ex: 7 dias)" class="pep-input med-duration">
            </div>
        </div>
    </template>

    <script src="../js/services/mock_db.js"></script>
    <script src="../js/services/auth.js"></script>
    <script src="../js/utils/utils.js"></script>
    <script>
        let currentPrescription = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Auth check
            if (!Auth.hasRole(['health_professional', 'clinic_admin', 'system_admin'])) {
                window.location.href = 'login.html';
                return;
            }

            loadPatients();
            addMedication(); // Start with one medication field
        });

        function loadPatients() {
            const patients = db.getPatients();
            const select = document.getElementById('patient-select');

            patients.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} - CPF: ${p.cpf}`;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                if (e.target.value) {
                    const patient = db.getPatient(parseInt(e.target.value));
                    document.getElementById('patient-info').classList.remove('hidden');
                    document.getElementById('patient-name').textContent = patient.name;
                    document.getElementById('patient-details').textContent =
                        `${patient.age} anos • ${patient.insurance} • Alergias: ${patient.allergies.join(', ') || 'Nenhuma'}`;
                } else {
                    document.getElementById('patient-info').classList.add('hidden');
                }
            });
        }

        function addMedication() {
            const template = document.getElementById('medication-template');
            const clone = template.content.cloneNode(true);
            document.getElementById('medications-list').appendChild(clone);
        }

        function removeMedication(btn) {
            btn.closest('.medication-item').remove();
        }

        function getMedications() {
            const items = document.querySelectorAll('.medication-item');
            const medications = [];

            items.forEach(item => {
                const name = item.querySelector('.med-name').value.trim();
                if (name) {
                    medications.push({
                        name,
                        dosage: item.querySelector('.med-dosage').value.trim(),
                        frequency: item.querySelector('.med-frequency').value.trim(),
                        duration: item.querySelector('.med-duration').value.trim()
                    });
                }
            });

            return medications;
        }

        function savePrescription(showPreview = false) {
            const patientId = document.getElementById('patient-select').value;
            const medications = getMedications();
            const notes = document.getElementById('prescription-notes').value.trim();

            if (!patientId) {
                Utils.showToast('Selecione um paciente', 'error');
                return;
            }

            if (medications.length === 0) {
                Utils.showToast('Adicione pelo menos um medicamento', 'error');
                return;
            }

            const user = Auth.getCurrentUser();
            const patient = db.getPatient(parseInt(patientId));

            currentPrescription = {
                patient_id: parseInt(patientId),
                patient_name: patient.name,
                professional_id: user.id,
                professional_name: user.name,
                medications,
                notes,
                date: new Date().toISOString().split('T')[0]
            };

            if (showPreview) {
                showPreviewModal();
            } else {
                const result = db.createPrescription({ ...currentPrescription, status: 'draft' });
                Utils.showToast('Rascunho salvo com sucesso!', 'success');
            }
        }

        function showPreviewModal() {
            const modal = document.getElementById('preview-modal');
            const content = document.getElementById('preview-content');

            content.innerHTML = `
                <div class="text-center border-b pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-emerald-600">MedClinic</h2>
                    <p class="text-sm text-gray-500">Prescrição Médica Digital</p>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Data: ${Utils.formatDate(currentPrescription.date)}</p>
                </div>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <p class="font-semibold">${currentPrescription.patient_name}</p>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-bold mb-3 border-b pb-2">Medicamentos</h3>
                    ${currentPrescription.medications.map((m, i) => `
                        <div class="mb-3 pl-4 border-l-2 border-emerald-500">
                            <p class="font-semibold">${i + 1}. ${m.name} ${m.dosage}</p>
                            <p class="text-sm text-gray-600">Tomar ${m.frequency} por ${m.duration}</p>
                        </div>
                    `).join('')}
                </div>
                
                ${currentPrescription.notes ? `
                    <div class="mb-6 p-4 bg-amber-50 rounded-lg">
                        <h3 class="font-bold mb-2">Observações</h3>
                        <p class="text-sm">${currentPrescription.notes}</p>
                    </div>
                ` : ''}
                
                <div class="mt-8 pt-4 border-t text-center">
                    <p class="font-semibold">${currentPrescription.professional_name}</p>
                    <p class="text-sm text-gray-500">CRM/SP 123456</p>
                    <div class="mt-4 p-3 bg-emerald-50 rounded-lg">
                        <p class="text-xs text-emerald-700">✓ Prescrição assinada digitalmente</p>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closePreview() {
            const modal = document.getElementById('preview-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function confirmAndDownload() {
            // Save to database
            const result = db.createPrescription({ ...currentPrescription, status: 'active' });

            // Generate PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(22);
            doc.setTextColor(0, 200, 150);
            doc.text('MedClinic', 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Prescrição Médica Digital', 105, 28, { align: 'center' });

            // Date
            doc.setFontSize(10);
            doc.setTextColor(0);
            doc.text(`Data: ${Utils.formatDate(currentPrescription.date)}`, 20, 45);

            // Patient
            doc.setFontSize(12);
            doc.text('Paciente:', 20, 60);
            doc.setFontSize(14);
            doc.text(currentPrescription.patient_name, 20, 68);

            // Medications
            doc.setFontSize(12);
            doc.text('Medicamentos:', 20, 85);

            let yPos = 95;
            currentPrescription.medications.forEach((m, i) => {
                doc.setFontSize(11);
                doc.text(`${i + 1}. ${m.name} ${m.dosage}`, 25, yPos);
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text(`   Tomar ${m.frequency} por ${m.duration}`, 25, yPos + 6);
                doc.setTextColor(0);
                yPos += 18;
            });

            // Notes
            if (currentPrescription.notes) {
                yPos += 10;
                doc.setFontSize(11);
                doc.text('Observações:', 20, yPos);
                doc.setFontSize(10);
                const splitNotes = doc.splitTextToSize(currentPrescription.notes, 170);
                doc.text(splitNotes, 20, yPos + 8);
            }

            // Signature
            doc.setFontSize(11);
            doc.text(currentPrescription.professional_name, 105, 250, { align: 'center' });
            doc.setFontSize(9);
            doc.text('CRM/SP 123456', 105, 257, { align: 'center' });

            doc.setTextColor(0, 150, 100);
            doc.text('✓ Prescrição assinada digitalmente', 105, 270, { align: 'center' });

            // Download
            doc.save(`prescricao_${result.id}.pdf`);

            Utils.showToast('Prescrição emitida com sucesso!', 'success');
            closePreview();

            // Clear form
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }
    </script>
</body>

</html>