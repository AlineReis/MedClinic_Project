<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prescrição Digital - MedClinic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#00C896',
                        'background-dark': '#0D1117',
                        'surface-dark': '#161B22',
                        'border-dark': '#30363D'
                    },
                    fontFamily: { display: ['Manrope', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400;
        }
    </style>
</head>

<body class="bg-background-dark text-white font-display min-h-screen">
    <!-- Header -->
    <header class="bg-surface-dark border-b border-border-dark sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="doctor-dashboard.html" class="text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">arrow_back</span>
                </a>
                <div class="flex items-center gap-2 text-primary">
                    <span class="material-symbols-outlined">local_hospital</span>
                    <span class="font-bold text-xl text-white">MedClinic</span>
                </div>
            </div>
            <h1 class="text-lg font-semibold">Nova Prescrição</h1>
            <div></div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Patient Selection -->
        <section class="bg-surface-dark border border-border-dark rounded-xl p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">person</span>
                Paciente
            </h2>
            <div class="flex items-center gap-4">
                <select id="patient-select"
                    class="flex-1 bg-background-dark border border-border-dark rounded-lg px-4 py-3 focus:border-primary focus:outline-none">
                    <option value="">Selecione o paciente...</option>
                </select>
                <div id="patient-info" class="hidden bg-background-dark rounded-lg p-4 flex-1">
                    <p class="font-semibold" id="patient-name"></p>
                    <p class="text-sm text-slate-400" id="patient-details"></p>
                </div>
            </div>
        </section>

        <!-- Medications -->
        <section class="bg-surface-dark border border-border-dark rounded-xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">medication</span>
                    Medicamentos
                </h2>
                <button onclick="addMedication()"
                    class="text-primary hover:text-white transition-colors text-sm flex items-center gap-1">
                    <span class="material-symbols-outlined text-lg">add_circle</span>
                    Adicionar
                </button>
            </div>

            <div id="medications-list" class="space-y-4">
                <!-- Medications will be added here -->
            </div>
        </section>

        <!-- Notes -->
        <section class="bg-surface-dark border border-border-dark rounded-xl p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">notes</span>
                Observações
            </h2>
            <textarea id="prescription-notes" rows="4" placeholder="Orientações adicionais para o paciente..."
                class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-3 focus:border-primary focus:outline-none resize-none"></textarea>
        </section>

        <!-- Actions -->
        <div class="flex gap-4">
            <button onclick="savePrescription(false)"
                class="flex-1 bg-surface-dark border border-border-dark text-white py-4 rounded-xl font-semibold hover:bg-border-dark transition-colors">
                Salvar Rascunho
            </button>
            <button onclick="savePrescription(true)"
                class="flex-1 bg-primary text-background-dark py-4 rounded-xl font-semibold hover:brightness-110 transition-all flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">verified</span>
                Emitir Prescrição Digital
            </button>
        </div>

        <!-- Preview Modal -->
        <div id="preview-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
            <div
                class="bg-surface-dark border border-border-dark rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                <div class="p-6 border-b border-border-dark flex items-center justify-between">
                    <h3 class="text-xl font-bold">Pré-visualização da Prescrição</h3>
                    <button onclick="closePreview()" class="text-slate-400 hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div id="preview-content" class="p-6 bg-white text-black">
                    <!-- Preview content will be injected here -->
                </div>
                <div class="p-6 border-t border-border-dark flex gap-4">
                    <button onclick="closePreview()"
                        class="flex-1 bg-surface-dark border border-border-dark py-3 rounded-xl hover:bg-border-dark transition-colors">
                        Editar
                    </button>
                    <button onclick="confirmAndDownload()"
                        class="flex-1 bg-primary text-background-dark py-3 rounded-xl font-semibold hover:brightness-110 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">download</span>
                        Baixar PDF
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Medication Template -->
    <template id="medication-template">
        <div class="medication-item bg-background-dark rounded-xl p-4 border border-border-dark">
            <div class="flex items-center justify-between mb-3">
                <span class="font-medium text-primary">Medicamento</span>
                <button type="button" onclick="removeMedication(this)" class="text-red-400 hover:text-red-300">
                    <span class="material-symbols-outlined text-lg">delete</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" placeholder="Nome do medicamento"
                    class="med-name bg-surface-dark border border-border-dark rounded-lg px-4 py-2 focus:border-primary focus:outline-none">
                <input type="text" placeholder="Dosagem (ex: 50mg)"
                    class="med-dosage bg-surface-dark border border-border-dark rounded-lg px-4 py-2 focus:border-primary focus:outline-none">
                <input type="text" placeholder="Frequência (ex: 12/12h)"
                    class="med-frequency bg-surface-dark border border-border-dark rounded-lg px-4 py-2 focus:border-primary focus:outline-none">
                <input type="text" placeholder="Duração (ex: 7 dias)"
                    class="med-duration bg-surface-dark border border-border-dark rounded-lg px-4 py-2 focus:border-primary focus:outline-none">
            </div>
        </div>
    </template>

    <script src="../js/services/mock_db.js"></script>
    <script src="../js/services/auth.js"></script>
    <script src="../js/utils/utils.js"></script>
    <script>
        let currentPrescription = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Auth check
            if (!Auth.hasRole(['health_professional', 'clinic_admin', 'system_admin'])) {
                window.location.href = 'login.html';
                return;
            }

            loadPatients();
            addMedication(); // Start with one medication field
        });

        function loadPatients() {
            const patients = db.getPatients();
            const select = document.getElementById('patient-select');

            patients.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} - CPF: ${p.cpf}`;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                if (e.target.value) {
                    const patient = db.getPatient(parseInt(e.target.value));
                    document.getElementById('patient-info').classList.remove('hidden');
                    document.getElementById('patient-name').textContent = patient.name;
                    document.getElementById('patient-details').textContent =
                        `${patient.age} anos • ${patient.insurance} • Alergias: ${patient.allergies.join(', ') || 'Nenhuma'}`;
                } else {
                    document.getElementById('patient-info').classList.add('hidden');
                }
            });
        }

        function addMedication() {
            const template = document.getElementById('medication-template');
            const clone = template.content.cloneNode(true);
            document.getElementById('medications-list').appendChild(clone);
        }

        function removeMedication(btn) {
            btn.closest('.medication-item').remove();
        }

        function getMedications() {
            const items = document.querySelectorAll('.medication-item');
            const medications = [];

            items.forEach(item => {
                const name = item.querySelector('.med-name').value.trim();
                if (name) {
                    medications.push({
                        name,
                        dosage: item.querySelector('.med-dosage').value.trim(),
                        frequency: item.querySelector('.med-frequency').value.trim(),
                        duration: item.querySelector('.med-duration').value.trim()
                    });
                }
            });

            return medications;
        }

        function savePrescription(showPreview = false) {
            const patientId = document.getElementById('patient-select').value;
            const medications = getMedications();
            const notes = document.getElementById('prescription-notes').value.trim();

            if (!patientId) {
                Utils.showToast('Selecione um paciente', 'error');
                return;
            }

            if (medications.length === 0) {
                Utils.showToast('Adicione pelo menos um medicamento', 'error');
                return;
            }

            const user = Auth.getCurrentUser();
            const patient = db.getPatient(parseInt(patientId));

            currentPrescription = {
                patient_id: parseInt(patientId),
                patient_name: patient.name,
                professional_id: user.id,
                professional_name: user.name,
                medications,
                notes,
                date: new Date().toISOString().split('T')[0]
            };

            if (showPreview) {
                showPreviewModal();
            } else {
                const result = db.createPrescription({ ...currentPrescription, status: 'draft' });
                Utils.showToast('Rascunho salvo com sucesso!', 'success');
            }
        }

        function showPreviewModal() {
            const modal = document.getElementById('preview-modal');
            const content = document.getElementById('preview-content');

            content.innerHTML = `
                <div class="text-center border-b pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-emerald-600">MedClinic</h2>
                    <p class="text-sm text-gray-500">Prescrição Médica Digital</p>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Data: ${Utils.formatDate(currentPrescription.date)}</p>
                </div>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <p class="font-semibold">${currentPrescription.patient_name}</p>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-bold mb-3 border-b pb-2">Medicamentos</h3>
                    ${currentPrescription.medications.map((m, i) => `
                        <div class="mb-3 pl-4 border-l-2 border-emerald-500">
                            <p class="font-semibold">${i + 1}. ${m.name} ${m.dosage}</p>
                            <p class="text-sm text-gray-600">Tomar ${m.frequency} por ${m.duration}</p>
                        </div>
                    `).join('')}
                </div>
                
                ${currentPrescription.notes ? `
                    <div class="mb-6 p-4 bg-amber-50 rounded-lg">
                        <h3 class="font-bold mb-2">Observações</h3>
                        <p class="text-sm">${currentPrescription.notes}</p>
                    </div>
                ` : ''}
                
                <div class="mt-8 pt-4 border-t text-center">
                    <p class="font-semibold">${currentPrescription.professional_name}</p>
                    <p class="text-sm text-gray-500">CRM/SP 123456</p>
                    <div class="mt-4 p-3 bg-emerald-50 rounded-lg">
                        <p class="text-xs text-emerald-700">✓ Prescrição assinada digitalmente</p>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closePreview() {
            const modal = document.getElementById('preview-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function confirmAndDownload() {
            // Save to database
            const result = db.createPrescription({ ...currentPrescription, status: 'active' });

            // Generate PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(22);
            doc.setTextColor(0, 200, 150);
            doc.text('MedClinic', 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Prescrição Médica Digital', 105, 28, { align: 'center' });

            // Date
            doc.setFontSize(10);
            doc.setTextColor(0);
            doc.text(`Data: ${Utils.formatDate(currentPrescription.date)}`, 20, 45);

            // Patient
            doc.setFontSize(12);
            doc.text('Paciente:', 20, 60);
            doc.setFontSize(14);
            doc.text(currentPrescription.patient_name, 20, 68);

            // Medications
            doc.setFontSize(12);
            doc.text('Medicamentos:', 20, 85);

            let yPos = 95;
            currentPrescription.medications.forEach((m, i) => {
                doc.setFontSize(11);
                doc.text(`${i + 1}. ${m.name} ${m.dosage}`, 25, yPos);
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text(`   Tomar ${m.frequency} por ${m.duration}`, 25, yPos + 6);
                doc.setTextColor(0);
                yPos += 18;
            });

            // Notes
            if (currentPrescription.notes) {
                yPos += 10;
                doc.setFontSize(11);
                doc.text('Observações:', 20, yPos);
                doc.setFontSize(10);
                const splitNotes = doc.splitTextToSize(currentPrescription.notes, 170);
                doc.text(splitNotes, 20, yPos + 8);
            }

            // Signature
            doc.setFontSize(11);
            doc.text(currentPrescription.professional_name, 105, 250, { align: 'center' });
            doc.setFontSize(9);
            doc.text('CRM/SP 123456', 105, 257, { align: 'center' });

            doc.setTextColor(0, 150, 100);
            doc.text('✓ Prescrição assinada digitalmente', 105, 270, { align: 'center' });

            // Download
            doc.save(`prescricao_${result.id}.pdf`);

            Utils.showToast('Prescrição emitida com sucesso!', 'success');
            closePreview();

            // Clear form
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }
    </script>
</body>

</html>